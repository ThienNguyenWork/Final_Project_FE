<!DOCTYPE html>
<html lang="en">

<head>
    <title>Song Detail</title>
</head>

<body class="bg-black text-white">

    <div id="song-detail" class="container mx-auto p-6">
        <button onclick="goBack()" class="bg-gray-700 p-2 rounded">⬅️ Quay lại</button>
        <div id="detail-content" class="mt-6"></div>

        <!-- User Table -->
        <div id="user-section" class="hidden">
            <h2 class="text-2xl mt-6">Đánh giá của bạn</h2>
            <form id="review-form" class="mt-4" onsubmit="submitReview(event)">
                <label for="rating">Chọn số sao:</label>
                <select id="rating" required>
                    <option value="1">⭐</option>
                    <option value="2">⭐⭐</option>
                    <option value="3">⭐⭐⭐</option>
                    <option value="4">⭐⭐⭐⭐</option>
                    <option value="5">⭐⭐⭐⭐⭐</option>
                </select>
                <label for="comment">Bình luận:</label>
                <input type="text" id="comment" placeholder="Nhập bình luận" required>
                <button type="submit" class="bg-blue-500 p-2 rounded mt-2">Gửi đánh giá</button>
            </form>
        </div>

        <!-- All Reviews Table -->
        <div id="artist-section" class="hidden">
            <h2 class="text-2xl mt-6">Tất cả đánh giá</h2>
            <div id="reviews-list"></div>
        </div>

        <!-- Admin Table -->
        <div id="admin-section" class="hidden">
            <h2 class="text-2xl mt-6">Quản lý đánh giá</h2>
            <div id="admin-reviews-list"></div>
        </div>


    </div>

    <script>
        const allProducts = JSON.parse(localStorage.getItem("products")) || [];

        function getSongDetail() {
            const params = new URLSearchParams(window.location.search);
            const songIndex = params.get('id');

            if (!songIndex || !allProducts[songIndex]) {
                document.getElementById('detail-content').innerHTML = '<p>Không tìm thấy bài hát!</p>';
                return;
            }

            const song = allProducts[songIndex];

            document.getElementById('detail-content').innerHTML = `
                <h1 class="text-4xl font-bold">${song.nameProduct}</h1>
                <p class="text-lg mt-2">Nghệ sĩ: ${song.nameArtist}</p>
                <p>Album: ${song.album || 'N/A'}</p>
                <p>Ngày phát hành: ${song.releaseDate}</p>
                <p>Thời lượng: ${song.time}</p>
                <img src="${song.imageLink}" alt="${song.nameProduct}" class="mt-4 rounded-lg w-64">
                ${song.audioLink ? `
                    <audio controls>
                        <source src="${song.audioLink}" type="audio/mp3">
                        Your browser does not support the audio element.
                    </audio>
                ` : `<p class="text-sm text-gray-400">No Audio</p>`}
            `;

            renderReviews(songIndex);
        }

        // Hiển thị bảng phản hồi
function toggleReplyForm(index) {
    const replyForm = document.getElementById(`reply-form-${index}`);
    replyForm.classList.toggle("hidden");
}

function showRoleSection(role) {
    const userSection = document.getElementById("user-section");
    const artistSection = document.getElementById("artist-section");
    const adminSection = document.getElementById("admin-section");

    // Reset all sections to hidden
    userSection.style.display = "none";
    artistSection.style.display = "none";
    adminSection.style.display = "none";

    // Show only appropriate sections based on role
    switch (role) {
        case "artist":
            artistSection.style.display = "block";  // Only show "Tất cả đánh giá"
            break;
        case "user":
            userSection.style.display = "block";    // Show "Đánh giá của bạn"
            artistSection.style.display = "block";  // Show "Tất cả đánh giá"
            break;
        case "admin":
            artistSection.style.display = "block";  // Show "Tất cả đánh giá"
            adminSection.style.display = "block";   // Show "Quản lý đánh giá"
            break;
    }
}

function renderReviews(songIndex) {
    const reviews = JSON.parse(localStorage.getItem(`reviews_${songIndex}`)) || [];
    const userList = document.getElementById("reviews-list");
    const adminList = document.getElementById("admin-reviews-list");
    const role = JSON.parse(localStorage.getItem("user"))?.role || "user";

    // Clear previous content
    userList.innerHTML = '';
    adminList.innerHTML = '';

    // Render reviews based on role
    reviews.forEach((r, i) => {
        const reviewHTML = `
            <div class="review-item">
                <p>${r.rating} - ${r.comment}</p>
                ${r.replies ? r.replies.map(reply => `<p class="reply mt-1 text-gray-600">Phản hồi: ${reply}</p>`).join('') : ''}

                <!-- Form phản hồi -->
                ${(role === "artist" || role === "admin") ? `
                <div id="reply-form-${i}" class="hidden mt-2">
                    <textarea id="reply-input-${i}" class="border p-1 w-full" placeholder="Nhập phản hồi..."></textarea>
                    <button onclick="submitReply(${i}, '${songIndex}')" class="bg-green-500 p-1 mt-1">Gửi phản hồi</button>
                </div>` : ''}
            </div>
        `;

        userList.innerHTML += reviewHTML;

        if (role === "admin") {
            adminList.innerHTML += `
                <div class="review-item">
                    <p>${r.rating} - ${r.comment}</p>
                    ${r.replies ? r.replies.map(reply => `<p class="reply mt-1 text-gray-600">Phản hồi: ${reply}</p>`).join('') : ''}
                    <button onclick="deleteReview(${i}, '${songIndex}')" class="bg-red-500 p-1 ml-2">Xóa</button>
                </div>
            `;
        }
    });

    showRoleSection(role);
}

// Lưu phản hồi vào localStorage
function submitReply(index, songIndex) {
    const reviews = JSON.parse(localStorage.getItem(`reviews_${songIndex}`)) || [];
    const replyInput = document.getElementById(`reply-input-${index}`).value;

    if (!replyInput.trim()) {
        alert("Phản hồi không được để trống!");
        return;
    }

    // Khởi tạo mảng phản hồi nếu chưa có
    if (!reviews[index].replies) {
        reviews[index].replies = [];
    }

    // Thêm phản hồi mới vào mảng
    reviews[index].replies.push(replyInput);
    localStorage.setItem(`reviews_${songIndex}`, JSON.stringify(reviews));

    // Làm mới giao diện
    renderReviews(songIndex);
}

document.addEventListener('DOMContentLoaded', () => {
    const role = JSON.parse(localStorage.getItem("user"))?.role || "user";
    const songIndex = new URLSearchParams(window.location.search).get('id');
    renderReviews(songIndex);
});

        function submitReview(event) {
            event.preventDefault();
            const params = new URLSearchParams(window.location.search);
            const songIndex = params.get('id');

            const rating = document.getElementById("rating").value;
            const comment = document.getElementById("comment").value;

            const reviews = JSON.parse(localStorage.getItem(`reviews_${songIndex}`)) || [];
            reviews.push({ rating, comment });

            localStorage.setItem(`reviews_${songIndex}`, JSON.stringify(reviews));

            document.getElementById("review-form").reset();
            renderReviews(songIndex);
        }



        function deleteReview(index, songIndex) {
            const reviews = JSON.parse(localStorage.getItem(`reviews_${songIndex}`)) || [];
            reviews.splice(index, 1);
            localStorage.setItem(`reviews_${songIndex}`, JSON.stringify(reviews));
            renderReviews(songIndex);
        }

        function goBack() {
            window.history.back();
        }

        window.onload = () => {
            getSongDetail();
            const role = JSON.parse(localStorage.getItem("user"))?.role || "user";
            showRoleSection(role); // Gọi hàm để hiển thị bảng theo vai trò
        };

    </script>

</body>

</html>